{% extends "layout.njk" %}

{% block pageTitle %}Create a task{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

    {% if errors and errors.global %}
      <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2>
        <div class="govuk-error-summary__body"><p>{{ errors.global }}</p></div>
      </div>
    {% endif %}

    <h1 class="govuk-heading-l">Create a task</h1>

    <form method="post" action="/tasks" novalidate>
      {% include "csrf.njk" ignore missing %}

      <div class="govuk-form-group {% if errors and errors.title %}govuk-form-group--error{% endif %}">
        <label class="govuk-label" for="title">Title</label>
        {% if errors and errors.title %}
          <p class="govuk-error-message"><span class="govuk-visually-hidden">Error:</span> {{ errors.title }}</p>
        {% endif %}
        <input class="govuk-input" id="title" name="title" type="text" value="{{ form.title | default('') }}">
      </div>

      <div class="govuk-form-group {% if errors and errors.caseNumber %}govuk-form-group--error{% endif %}">
        <label class="govuk-label" for="caseNumber">Case number</label>
        {% if errors and errors.caseNumber %}
          <p class="govuk-error-message"><span class="govuk-visually-hidden">Error:</span> {{ errors.caseNumber }}</p>
        {% endif %}
        <input class="govuk-input" id="caseNumber" name="caseNumber" type="text" value="{{ form.caseNumber | default('') }}">
      </div>

      <div class="govuk-form-group {% if errors and errors.status %}govuk-form-group--error{% endif %}">
        <label class="govuk-label" for="status">Status</label>
        {% if errors and errors.status %}
          <p class="govuk-error-message"><span class="govuk-visually-hidden">Error:</span> {{ errors.status }}</p>
        {% endif %}
        <select class="govuk-select" id="status" name="status">
          {% for s in statuses %}
            <option value="{{ s }}" {% if form.status == s %}selected{% endif %}>{{ s | replace("_"," ") }}</option>
          {% endfor %}
        </select>
      </div>

    {# --- replace ONLY the due date form-group with this --- #}
<div class="govuk-form-group {% if errors and errors.dueDate %}govuk-form-group--error{% endif %}">
  <label class="govuk-label" for="dueDate">Due date/time (optional)</label>
  {% if errors and errors.dueDate %}
    <p class="govuk-error-message">
      <span class="govuk-visually-hidden">Error:</span> {{ errors.dueDate }}
    </p>
  {% endif %}
  <input
    class="govuk-input"
    id="dueDate"
    name="dueDate"
    type="datetime-local"
    value="{{ form.dueDate | default('') }}"
  >
  <div class="govuk-hint">Must be today or later.</div>
</div>

      <button class="govuk-button" data-module="govuk-button" type="submit">Create task</button>
      <a class="govuk-link" href="/tasks">Cancel</a>
    </form>
  </div>

  {# Right column: Description with live character/word counter (no macro) #}
  <div class="govuk-grid-column-one-third">
    <div class="govuk-character-count"
         data-module="govuk-character-count"
         data-maxwords="500">
      <div class="govuk-form-group {% if errors and errors.description %}govuk-form-group--error{% endif %}">
        <label class="govuk-label" for="description">Description (optional)</label>
        {% if errors and errors.description %}
          <p class="govuk-error-message"><span class="govuk-visually-hidden">Error:</span> {{ errors.description }}</p>
        {% endif %}

        <textarea class="govuk-textarea govuk-js-character-count app-textarea--tall"
                  id="description"
                  name="description"
                  rows="16"
                  aria-describedby="description-info">{{ form.description | default('') }}</textarea>
      </div>

      <div id="description-info"
           class="govuk-hint govuk-character-count__message"
           aria-live="polite">
        You can enter up to 500 words
      </div>
    </div>
  </div>
</div>
<script>
  (function () {
    var el = document.getElementById('dueDate');
    if (!el) return;

    // Build "YYYY-MM-DDTHH:MM" in local time, seconds = 00
    var d = new Date();
    d.setSeconds(0, 0);
    var pad = function(n){ return String(n).padStart(2,'0'); };
    var min = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
              'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    el.min = min;
  })();
</script>
{% endblock %}